---
const pathname = decodeURIComponent(Astro.url.pathname || ""); //解码
const postName = pathname?.split("/").pop();
---

<meta
	data-giscus_repo="fiat24/astroblog"
	data-giscus_repo_id="R_kgDONnB1Tg"
	data-giscus_category_id="DIC_kwDONnB1Ts4Cl1Oz"
	data-giscus_lang="zh-CN"
	id="giscus-meta"
/>
<meta property={`og:${postName}`} />
<div id="giscus-container" class="mt-8 w-full"></div>
<script>
	function initGiscus() {
		const meta = document.querySelector("#giscus-meta") as HTMLElement;
		if (!meta) return;

		const {
			giscus_repo = "",
			giscus_repo_id = "",
			giscus_category_id = "",
			giscus_lang,
		} = meta.dataset;

		function sendMessage(message: Object) {
			const iframe = document.querySelector("iframe.giscus-frame") as HTMLIFrameElement;
			if (!iframe || !iframe.contentWindow) return;
			iframe.contentWindow.postMessage({ giscus: message }, "https://giscus.app");
		}

		function getCurrentTheme() {
			const theme =
				document.firstElementChild && document.firstElementChild.getAttribute("data-theme");
			return theme;
		}

		const container = document.querySelector("#giscus-container");
		if (!container) return;

		// Clear previous Giscus instance (for Client Router navigations)
		container.innerHTML = "";

		const theme = getCurrentTheme() == "light" ? "light" : "dark_dimmed";
		let script = document.createElement("script");
		script.src = "https://giscus.app/client.js";
		script.setAttribute("data-repo", giscus_repo);
		script.setAttribute("data-repo-id", giscus_repo_id);
		script.setAttribute("data-category", "Announcements");
		script.setAttribute("data-category-id", giscus_category_id);
		script.setAttribute("data-mapping", "title");
		script.setAttribute("data-strict", "0");
		script.setAttribute("data-reactions-enabled", "1");
		script.setAttribute("data-emit-metadata", "0");
		script.setAttribute("data-input-position", "top");
		script.setAttribute("data-theme", theme);
		script.setAttribute("data-lang", giscus_lang || "en");
		script.setAttribute("data-loading", "lazy");
		script.setAttribute("crossorigin", "anonymous");
		script.async = true;
		container.appendChild(script);

		document.querySelector("#theme-btn")?.addEventListener("click", () => {
			const theme = getCurrentTheme();
			sendMessage({
				setConfig: { theme: theme == "light" ? "dark_dimmed" : "light" },
			});
		});
	}

	// Run on every navigation (including Client Router soft navigations)
	document.addEventListener("astro:page-load", initGiscus);
</script>
